---
# Base template: HTTP Server with configurable routes
kind: TemplateDefinition
metadata:
  name: HttpServer
schema:
  type: object
  properties:
    name:
      type: string
      default: 'server'
    port:
      type: integer
      default: 8080
    routes:
      type: array
      items:
        type: object
        properties:
          path:
            type: string
          handler:
            type: string
      default: []
  required: [name, port]
resources:
  - kind: Http.Server
    metadata:
      name: '${{ name }}'
    port: ${{ port }}
    routes:
      - for: 'route in routes'
        path: '${{ route.path }}'
        handler: '${{ route.handler }}'

---
# Higher-level template: Multi-region deployment
kind: TemplateDefinition
metadata:
  name: MultiRegionDeployment
schema:
  type: object
  properties:
    serviceName:
      type: string
      default: 'myservice'
    basePort:
      type: integer
      default: 8000
    regions:
      type: array
      items:
        type: string
      default: ['us-east', 'eu-west']
    routes:
      type: array
      items:
        type: object
      default:
        - path: '/health'
          handler: 'Logic.JavaScript.HealthCheck'
  required: [serviceName, regions]
resources:
  # Generate a server for each region using the HttpServer template
  - for: 'region, index in regions'
    kind: Template.HttpServer
    metadata:
      name: '${{ serviceName }}-${{ region }}'
    name: '${{ serviceName }}-${{ region }}'
    port: ${{ basePort + index }}
    routes: ${{ routes }}

---
# Example: Instantiate the multi-region template
kind: Template.MultiRegionDeployment
metadata:
  name: ProductionDeployment
serviceName: 'api'
basePort: 9000
regions: ['us-east-1', 'us-west-2', 'eu-central-1']
routes:
  - path: '/health'
    handler: 'Logic.JavaScript.HealthCheck'
  - path: '/api/users'
    handler: 'Logic.JavaScript.GetUsers'
  - path: '/api/products'
    handler: 'Logic.JavaScript.GetProducts'
