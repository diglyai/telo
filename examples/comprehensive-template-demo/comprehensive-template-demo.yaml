---
# Comprehensive Template Example
# Demonstrates all major features of the TemplateDefinition system

# ============================================================================
# FEATURE 1: Basic Template with JSONSchema and Defaults
# ============================================================================
kind: TemplateDefinition
metadata:
  name: MicroserviceBase
schema:
  type: object
  properties:
    serviceName:
      type: string
      description: 'Unique name for the microservice'
    port:
      type: integer
      default: 8080
      description: 'HTTP port for the service'
    logLevel:
      type: string
      default: 'info'
      description: 'Logging level (debug, info, warn, error)'
    enableHealthCheck:
      type: boolean
      default: true
      description: 'Enable /health endpoint'
  required: [serviceName]
resources:
  - kind: Http.Server
    metadata:
      name: '${{ serviceName }}-server'
    port: ${{ port }}
    logLevel: '${{ logLevel }}'

  - if: 'enableHealthCheck'
    kind: Http.Route
    metadata:
      name: '${{ serviceName }}-health'
    path: '/health'
    handler: 'Logic.JavaScript.HealthCheck'

---
# ============================================================================
# FEATURE 2: For Loops - Array Iteration
# ============================================================================
kind: TemplateDefinition
metadata:
  name: LoadBalancedService
schema:
  type: object
  properties:
    serviceName:
      type: string
    replicas:
      type: integer
      default: 3
    basePort:
      type: integer
      default: 9000
  required: [serviceName]
resources:
  - for: 'i in range(0, replicas)'
    kind: Http.Server
    metadata:
      name: '${{ serviceName }}-replica-${{ i }}'
    port: ${{ basePort + i }}

---
# ============================================================================
# FEATURE 3: For Loops with Index - Multi-Region Deployment
# ============================================================================
kind: TemplateDefinition
metadata:
  name: MultiRegionService
schema:
  type: object
  properties:
    serviceName:
      type: string
    regions:
      type: array
      items:
        type: object
        properties:
          name: { type: string }
          port: { type: integer }
      default:
        - name: 'us-east-1'
          port: 8080
        - name: 'eu-west-1'
          port: 8080
  required: [serviceName]
resources:
  - for: 'index, region in regions'
    kind: Http.Server
    metadata:
      name: '${{ serviceName }}-${{ region.name }}'
    port: ${{ region.port }}
    region: '${{ region.name }}'
    priority: ${{ index }}

---
# ============================================================================
# FEATURE 4: Conditionals - Feature Flags
# ============================================================================
kind: TemplateDefinition
metadata:
  name: FeatureEnabledService
schema:
  type: object
  properties:
    serviceName:
      type: string
    features:
      type: object
      properties:
        authentication: { type: boolean, default: false }
        rateLimit: { type: boolean, default: false }
        caching: { type: boolean, default: false }
        monitoring: { type: boolean, default: true }
      default:
        authentication: true
        rateLimit: true
        caching: false
        monitoring: true
  required: [serviceName]
resources:
  - kind: Http.Server
    metadata:
      name: '${{ serviceName }}'
    port: 8080

  - if: 'features.authentication'
    kind: Auth.Provider
    metadata:
      name: '${{ serviceName }}-auth'

  - if: 'features.rateLimit'
    kind: RateLimit.Policy
    metadata:
      name: '${{ serviceName }}-ratelimit'
    maxRequests: 1000

  - if: 'features.caching'
    kind: Cache.Provider
    metadata:
      name: '${{ serviceName }}-cache'

  - if: 'features.monitoring'
    kind: Monitoring.Agent
    metadata:
      name: '${{ serviceName }}-monitor'

---
# ============================================================================
# FEATURE 5: Property-Level Control Flow
# ============================================================================
kind: TemplateDefinition
metadata:
  name: RestApiService
schema:
  type: object
  properties:
    serviceName:
      type: string
    endpoints:
      type: array
      items:
        type: object
        properties:
          resource: { type: string }
          methods: { type: array, items: { type: string } }
      default:
        - resource: 'users'
          methods: ['GET', 'POST', 'PUT', 'DELETE']
        - resource: 'posts'
          methods: ['GET', 'POST']
  required: [serviceName]
resources:
  - kind: Http.Api
    metadata:
      name: '${{ serviceName }}-api'
    routes:
      # Property-level for loop
      - for: 'endpoint in endpoints'
        path: '/api/${{ endpoint.resource }}'
        methods: ${{ endpoint.methods }}
        handler: 'Logic.JavaScript.${{ endpoint.resource }}Handler'

---
# ============================================================================
# FEATURE 6: Recursive Templates
# ============================================================================
kind: TemplateDefinition
metadata:
  name: GlobalDeployment
schema:
  type: object
  properties:
    appName:
      type: string
    environments:
      type: array
      items:
        type: object
        properties:
          name: { type: string }
          regions: { type: array, items: { type: string } }
      default:
        - name: 'production'
          regions: ['us-east-1', 'eu-west-1']
        - name: 'staging'
          regions: ['us-west-2']
  required: [appName]
resources:
  # This template uses MultiRegionService template
  - for: 'env in environments'
    kind: Template.MultiRegionService
    metadata:
      name: '${{ appName }}-${{ env.name }}'
    serviceName: '${{ appName }}-${{ env.name }}'
    regions:
      - for: 'region in env.regions'
        name: '${{ region }}'
        port: 8080

---
# ============================================================================
# FEATURE 7: Complex CEL Expressions
# ============================================================================
kind: TemplateDefinition
metadata:
  name: SmartScalingService
schema:
  type: object
  properties:
    serviceName:
      type: string
    environment:
      type: string
      default: 'development'
    scalingRules:
      type: object
      default:
        development: { min: 1, max: 2 }
        staging: { min: 2, max: 5 }
        production: { min: 5, max: 20 }
  required: [serviceName]
resources:
  - kind: Autoscaler.Policy
    metadata:
      name: '${{ serviceName }}-scaler'
    minInstances: ${{ scalingRules[environment].min }}
    maxInstances: ${{ scalingRules[environment].max }}
    targetService: '${{ serviceName }}'

  # Conditional based on environment
  - if: "environment == 'production'"
    kind: HighAvailability.Config
    metadata:
      name: '${{ serviceName }}-ha'

---
# ============================================================================
# INSTANTIATION EXAMPLES
# ============================================================================

# Example 1: Basic microservice
kind: ComprehensiveTemplateDemo.MicroserviceBase
metadata:
  name: UserService
serviceName: 'user-service'
port: 3000
logLevel: 'debug'
enableHealthCheck: true

---
# Example 2: Multi-region deployment
kind: ComprehensiveTemplateDemo.MultiRegionService
metadata:
  name: ApiGateway
serviceName: 'api-gateway'
regions:
  - name: 'us-east-1'
    port: 8080
  - name: 'us-west-2'
    port: 8080
  - name: 'eu-central-1'
    port: 8080

---
# Example 3: Feature-enabled service
kind: ComprehensiveTemplateDemo.FeatureEnabledService
metadata:
  name: PaymentService
serviceName: 'payment-service'
features:
  authentication: true
  rateLimit: true
  caching: true
  monitoring: true

---
# Example 4: REST API with custom endpoints
kind: ComprehensiveTemplateDemo.RestApiService
metadata:
  name: BlogApi
serviceName: 'blog-api'
endpoints:
  - resource: 'articles'
    methods: ['GET', 'POST', 'PUT', 'DELETE']
  - resource: 'comments'
    methods: ['GET', 'POST', 'DELETE']
  - resource: 'categories'
    methods: ['GET']

---
# Example 5: Recursive global deployment
kind: ComprehensiveTemplateDemo.GlobalDeployment
metadata:
  name: GlobalApp
appName: 'my-global-app'
environments:
  - name: 'production'
    regions: ['us-east-1', 'us-west-2', 'eu-central-1', 'ap-southeast-1']
  - name: 'staging'
    regions: ['us-west-2']
  - name: 'development'
    regions: ['us-east-1']

---
# Example 6: Environment-aware scaling
kind: ComprehensiveTemplateDemo.SmartScalingService
metadata:
  name: ProductionScaler
serviceName: 'production-api'
environment: 'production'
# Will use production scaling rules: min 5, max 20, with HA enabled
